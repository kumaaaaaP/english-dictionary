name: Generate Vocabulary HTML Files
# vocabulary_data*.json ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
on:
  push:
    branches:
      - main
    paths:
      - 'vocabulary_data*.json'
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. dataãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
      - name: Create data directory
        run: mkdir -p data
      
      # ðŸ” ãƒ‡ãƒãƒƒã‚°: JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
      - name: Debug - List JSON files
        run: |
          echo "=== JSON files in repository ==="
          ls -la vocabulary_data*.json 2>/dev/null || echo "No JSON files found"
          echo ""
          echo "=== Checking each JSON file ==="
          for file in vocabulary_data*.json; do
            if [ -f "$file" ]; then
              echo "File: $file"
              echo "Size: $(wc -c < "$file") bytes"
              echo "First 200 chars:"
              head -c 200 "$file"
              echo ""
              echo "---"
            fi
          done
      
      # ðŸ” ãƒ‡ãƒãƒƒã‚°: æ—¢å­˜ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
      - name: Debug - List existing HTML files
        run: |
          echo "=== Existing HTML files in data/ ==="
          ls -la data/*.html 2>/dev/null || echo "No HTML files in data/"
          echo "Total HTML files: $(ls -1 data/*.html 2>/dev/null | wc -l)"
      
      # 4. å˜èªžHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
      - name: Generate vocabulary HTML files
        run: |
          echo "=== Running generate_vocab.py ==="
          python generate_vocab.py
          echo ""
          echo "=== Script completed ==="
      
      # ðŸ” ãƒ‡ãƒãƒƒã‚°: ç”Ÿæˆå¾Œã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
      - name: Debug - List generated HTML files
        run: |
          echo "=== HTML files after generation ==="
          ls -la data/*.html 2>/dev/null || echo "No HTML files generated"
          echo "Total HTML files: $(ls -1 data/*.html 2>/dev/null | wc -l)"
          echo ""
          echo "=== Recently modified files in data/ ==="
          find data/ -name "*.html" -type f -mmin -5 2>/dev/null || echo "No recently modified HTML files"
      
      # 5. index.htmlã‚’æ›´æ–°ï¼ˆbuild_index.py ã‚’ä½¿ç”¨ï¼‰
      - name: Update index.html
        run: |
          python build_index.py
          echo "âœ… index.html updated"
      
      # ðŸ” ãƒ‡ãƒãƒƒã‚°: Git ã®å¤‰æ›´ç¢ºèªï¼ˆè©³ç´°ç‰ˆï¼‰
      - name: Debug - Check Git changes
        run: |
          echo "=== Git status ==="
          git status
          echo ""
          echo "=== Git diff summary ==="
          git diff --stat
          echo ""
          echo "=== Untracked files ==="
          git ls-files --others --exclude-standard
      
      # 6. å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      - name: Check for changes
        id: check_changes
        run: |
          # æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã¨å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯
          if [ -n "$(git status --porcelain data/ index.html)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
            git status --porcelain data/ index.html
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          fi
      
      # 7. ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/*.html index.html
          git commit -m "ðŸ¤– Auto-generate vocabulary HTML files and update index [skip ci]"
          git push
      
      # 8. å®Œäº†ã‚µãƒžãƒªãƒ¼
      - name: Job summary
        run: |
          echo "## ðŸ“Š Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### JSON Files Detected" >> $GITHUB_STEP_SUMMARY
          for file in vocabulary_data*.json; do
            if [ -f "$file" ]; then
              echo "- \`$file\` ($(wc -c < "$file") bytes)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated HTML Files" >> $GITHUB_STEP_SUMMARY
          html_count=$(ls -1 data/*.html 2>/dev/null | wc -l)
          echo "- Total: $html_count files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changed }}" = "true" ]; then
            echo "âœ… Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes to commit" >> $GITHUB_STEP_SUMMARY
          fi

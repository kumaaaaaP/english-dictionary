name: Generate Vocabulary HTML Files
# vocabulary_data*.json ã¾ãŸã¯ data/ ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
on:
  push:
    branches:
      - main
    paths:
      - 'vocabulary_data*.json'
      - 'data/**'
      - 'build_index.py'
      - 'generate_vocab.py'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  generate:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. dataãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
      - name: Create data directory
        run: mkdir -p data
      
      # 4. å˜èªžHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆï¼ˆJSONãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿ï¼‰
      - name: Check if JSON files changed
        id: check_json
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "vocabulary_data.*\.json"; then
            echo "json_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… JSON files changed - will generate HTML"
          else
            echo "json_changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No JSON changes - skipping HTML generation"
          fi
      
      - name: Generate vocabulary HTML files
        if: steps.check_json.outputs.json_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ”§ Generating HTML files..."
          python generate_vocab.py
          echo ""
          echo "ðŸ“ Files in data/ directory:"
          ls -lh data/ | head -20
          echo ""
          echo "âœ… Vocabulary HTML files generated"
      
      # 5. index.htmlã‚’æ›´æ–°ï¼ˆbuild_index.py ã‚’ä½¿ç”¨ï¼‰
      - name: Update index.html
        run: |
          python build_index.py
          echo "âœ… index.html updated"
      
      # 6. å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      - name: Check for changes
        id: check_changes
        run: |
          echo "ðŸ“Š Git status:"
          git status
          echo ""
          echo "ðŸ“ Git diff for data/:"
          git diff --stat data/
          echo ""
          echo "ðŸ“ Git diff for index.html:"
          git diff --stat index.html
          echo ""
          
          if git diff --quiet data/ index.html; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
          fi
      
      # 7. ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          echo "ðŸ“¦ Adding files to git..."
          git add data/*.html index.html
          
          echo "ðŸ“‹ Files to be committed:"
          git diff --cached --name-only
          
          echo "ðŸ’¾ Committing changes..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "ðŸ¤– Auto-generate vocabulary HTML files and update index [skip ci]"
          
          echo "ðŸš€ Pushing changes..."
          git push
          
          echo "âœ… Changes pushed successfully"
      
      # 8. å®Œäº†ã‚µãƒžãƒªãƒ¼
      - name: Job summary
        run: |
          echo "## ðŸ“Š Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### JSON Files Detected" >> $GITHUB_STEP_SUMMARY
          ls -1 vocabulary_data*.json 2>/dev/null | while read file; do
            count=$(jq '.words | length' "$file" 2>/dev/null || echo "0")
            echo "- \`$file\`: $count words" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Vocabulary HTML files generated in \`data/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "âœ… \`index.html\` updated with new words" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          ls -1 data/*.html 2>/dev/null | wc -l | xargs -I {} echo "{} HTML files in data/" >> $GITHUB_STEP_SUMMARY

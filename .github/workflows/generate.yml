name: Generate Vocabulary HTML Files
# vocabulary_data*.json ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
on:
  push:
    branches:
      - main
    paths:
      - 'vocabulary_data*.json'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  generate:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆgit diffã®ãŸã‚ï¼‰
      
      # 2. Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. dataãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
      - name: Create data directory
        run: mkdir -p data
      
      # 4. å˜èªžHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
      - name: Generate vocabulary HTML files
        run: |
          echo "ðŸ”§ Generating HTML files..."
          python generate_vocab.py
          echo ""
          echo "ðŸ“ Files in data/ directory (æœ€åˆã®20ä»¶):"
          ls -lh data/ | head -20
          echo ""
          echo "ðŸ“Š Total HTML files:"
          ls -1 data/*.html 2>/dev/null | wc -l
          echo ""
          echo "âœ… Vocabulary HTML files generated"
      
      # 5. index.htmlã‚’æ›´æ–°ï¼ˆbuild_index.py ã‚’ä½¿ç”¨ï¼‰
      - name: Update index.html
        run: |
          python build_index.py
          echo "âœ… index.html updated"
      
      # 6. å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      - name: Check for changes
        id: check_changes
        run: |
          echo "ðŸ“Š Git status:"
          git status
          echo ""
          
          # æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã¨å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          if [ -n "$(git status --porcelain data/ index.html)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected:"
            git status --porcelain data/ index.html
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          fi
      
      # 7. ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          echo "ðŸ“¦ Adding files to git..."
          git add data/*.html index.html
          
          echo "ðŸ“‹ Files to be committed:"
          git status --short
          
          echo "ðŸ’¾ Committing changes..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "ðŸ¤– Auto-generate vocabulary HTML files and update index [skip ci]"
          
          echo "ðŸš€ Pushing changes..."
          git push
          
          echo "âœ… Changes pushed successfully"
      
      # 8. å®Œäº†ã‚µãƒžãƒªãƒ¼
      - name: Job summary
        run: |
          echo "## ðŸ“Š Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### JSON Files Processed" >> $GITHUB_STEP_SUMMARY
          for file in vocabulary_data*.json; do
            if [ -f "$file" ]; then
              count=$(python3 -c "import json; print(len(json.load(open('$file'))['words']))" 2>/dev/null || echo "0")
              echo "- \`$file\`: $count words" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          total=$(ls -1 data/*.html 2>/dev/null | wc -l)
          echo "- Total: **$total HTML files** in \`data/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… \`index.html\` updated with all vocabulary entries" >> $GITHUB_STEP_SUMMARY
